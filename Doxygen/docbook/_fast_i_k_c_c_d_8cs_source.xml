<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="__fast_i_k_c_c_d_8cs_source">
<title>FastIKCCD.cs</title>
<indexterm><primary>O:/GitHUBMINIPRoject/Assets/FastIK/Scripts/FastIK/FastIKCCD.cs</primary></indexterm>
<programlisting>00001 <emphasis role="keyword">using</emphasis>&#32;<link linkend="__balloon_8cs_1a7d67e097df9376eb709b6a23aa3c7d23">UnityEngine</link>;
00002 <emphasis role="comment">/*</emphasis>
00003 <emphasis role="comment">public&#32;class&#32;IKCCD&#32;:&#32;MonoBehaviour</emphasis>
00004 <emphasis role="comment">{</emphasis>
00005 <emphasis role="comment">&#32;&#32;&#32;&#32;public&#32;int&#32;ChainLength&#32;=&#32;2;</emphasis>
00006 <emphasis role="comment">&#32;&#32;&#32;&#32;public&#32;Transform&#32;Target;</emphasis>
00007 <emphasis role="comment">&#32;&#32;&#32;&#32;protected&#32;Quaternion&#32;TargetInitialRotation;</emphasis>
00008 <emphasis role="comment">&#32;&#32;&#32;&#32;protected&#32;Quaternion&#32;EndInitialRotation;</emphasis>
00009 <emphasis role="comment">&#32;&#32;&#32;&#32;public&#32;Transform&#32;Pole;</emphasis>
00010 <emphasis role="comment">&#32;&#32;&#32;&#32;protected&#32;float&#32;CompleteLength;</emphasis>
00011 <emphasis role="comment"></emphasis>
00012 <emphasis role="comment">&#32;&#32;&#32;&#32;public&#32;int&#32;Iterations&#32;=&#32;10;</emphasis>
00013 <emphasis role="comment">&#32;&#32;&#32;&#32;public&#32;float&#32;Delta&#32;=&#32;0.001f;</emphasis>
00014 <emphasis role="comment"></emphasis>
00015 <emphasis role="comment">&#32;&#32;&#32;&#32;protected&#32;Transform[]&#32;Bones;</emphasis>
00016 <emphasis role="comment">&#32;&#32;&#32;&#32;//protected&#32;Quaternion[]&#32;InitialRotation;</emphasis>
00017 <emphasis role="comment"></emphasis>
00018 <emphasis role="comment"></emphasis>
00019 <emphasis role="comment">&#32;&#32;&#32;&#32;//&#32;Start&#32;is&#32;called&#32;before&#32;the&#32;first&#32;frame&#32;update</emphasis>
00020 <emphasis role="comment">&#32;&#32;&#32;&#32;void&#32;Awake()</emphasis>
00021 <emphasis role="comment">&#32;&#32;&#32;&#32;{</emphasis>
00022 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//initial&#32;length</emphasis>
00023 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones&#32;=&#32;new&#32;Transform[ChainLength&#32;+&#32;1];</emphasis>
00024 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//InitialRotation&#32;=&#32;new&#32;Quaternion[ChainLength&#32;+&#32;1];</emphasis>
00025 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;TargetInitialRotation&#32;=&#32;Target.rotation;</emphasis>
00026 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;EndInitialRotation&#32;=&#32;transform.rotation;</emphasis>
00027 <emphasis role="comment"></emphasis>
00028 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;current&#32;=&#32;transform;</emphasis>
00029 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;CompleteLength&#32;=&#32;0;</emphasis>
00030 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(int&#32;i&#32;=&#32;ChainLength&#32;-&#32;1;&#32;i&#32;&gt;=&#32;0;&#32;i--)</emphasis>
00031 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00032 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;CompleteLength&#32;+=&#32;(current.position&#32;-&#32;current.parent.position).magnitude;</emphasis>
00033 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones[i&#32;+&#32;1]&#32;=&#32;current;</emphasis>
00034 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones[i]&#32;=&#32;current.parent;</emphasis>
00035 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//InitialRotation[i&#32;+&#32;1]&#32;=&#32;current.rotation;</emphasis>
00036 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//InitialRotation[i]&#32;=&#32;current.parent.rotation;</emphasis>
00037 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;current&#32;=&#32;current.parent;</emphasis>
00038 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00039 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(Bones[0]&#32;==&#32;null)</emphasis>
00040 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;new&#32;UnityException(&quot;The&#32;chain&#32;value&#32;is&#32;longer&#32;than&#32;the&#32;ancestor&#32;chain!&quot;);</emphasis>
00041 <emphasis role="comment">&#32;&#32;&#32;&#32;}</emphasis>
00042 <emphasis role="comment"></emphasis>
00043 <emphasis role="comment">&#32;&#32;&#32;&#32;//&#32;Update&#32;is&#32;called&#32;once&#32;per&#32;frame</emphasis>
00044 <emphasis role="comment">&#32;&#32;&#32;&#32;void&#32;LateUpdate()</emphasis>
00045 <emphasis role="comment">&#32;&#32;&#32;&#32;{</emphasis>
00046 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//CCD</emphasis>
00047 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;lastBone&#32;=&#32;Bones[Bones.Length&#32;-&#32;1];</emphasis>
00048 <emphasis role="comment"></emphasis>
00049 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//for&#32;(var&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;Bones.Length;&#32;i++)</emphasis>
00050 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;Bones[i].rotation&#32;=&#32;InitialRotation[i];</emphasis>
00051 <emphasis role="comment"></emphasis>
00052 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(int&#32;iteration&#32;=&#32;0;&#32;iteration&#32;&lt;&#32;Iterations;&#32;iteration++)</emphasis>
00053 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00054 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(var&#32;i&#32;=&#32;Bones.Length&#32;-&#32;1;&#32;i&#32;&gt;=&#32;0;&#32;i--)</emphasis>
00055 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00056 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//https://www.youtube.com/watch?v=MA1nT9RAF3k</emphasis>
00057 <emphasis role="comment"></emphasis>
00058 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(i&#32;==&#32;Bones.Length&#32;-&#32;1)</emphasis>
00059 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00060 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones[i].rotation&#32;=&#32;Target.rotation&#32;*&#32;Quaternion.Inverse(TargetInitialRotation)&#32;*&#32;EndInitialRotation;</emphasis>
00061 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00062 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else</emphasis>
00063 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00064 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones[i].rotation&#32;=&#32;Quaternion.FromToRotation(lastBone.position&#32;-&#32;Bones[i].position,&#32;Target.position&#32;-&#32;Bones[i].position)&#32;*&#32;Bones[i].rotation;</emphasis>
00065 <emphasis role="comment"></emphasis>
00066 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//jitter&#32;to&#32;solve&#32;strait&#32;line</emphasis>
00067 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//if&#32;(iteration&#32;==&#32;5&#32;&amp;&amp;&#32;i&#32;==&#32;0&#32;&amp;&amp;&#32;(Target.position&#32;-&#32;lastBone.position).sqrMagnitude&#32;&gt;&#32;0.01f&#32;&amp;&amp;&#32;(Target.position&#32;-&#32;Bones[i].position).sqrMagnitude&#32;&lt;&#32;CompleteLength&#32;*&#32;CompleteLength)</emphasis>
00068 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;&#32;&#32;Bones[i].rotation&#32;=&#32;Quaternion.AngleAxis(10,&#32;Vector3.up)&#32;*&#32;Bones[i].rotation;</emphasis>
00069 <emphasis role="comment"></emphasis>
00070 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//move&#32;towards&#32;pole</emphasis>
00071 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(Pole&#32;!=&#32;null&#32;&amp;&amp;&#32;i&#32;+&#32;2&#32;&lt;=&#32;Bones.Length&#32;-&#32;1)</emphasis>
00072 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00073 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;plane&#32;=&#32;new&#32;Plane(Bones[i&#32;+&#32;2].position&#32;-&#32;Bones[i].position,&#32;Bones[i].position);</emphasis>
00074 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;projectedPole&#32;=&#32;plane.ClosestPointOnPlane(Pole.position);</emphasis>
00075 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;projectedBone&#32;=&#32;plane.ClosestPointOnPlane(Bones[i&#32;+&#32;1].position);</emphasis>
00076 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;((projectedBone&#32;-&#32;Bones[i].position).sqrMagnitude&#32;&gt;&#32;0.01f)</emphasis>
00077 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{</emphasis>
00078 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;angle&#32;=&#32;Vector3.SignedAngle(projectedBone&#32;-&#32;Bones[i].position,&#32;projectedPole&#32;-&#32;Bones[i].position,&#32;plane.normal);</emphasis>
00079 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Bones[i].rotation&#32;=&#32;Quaternion.AngleAxis(angle,&#32;plane.normal)&#32;*&#32;Bones[i].rotation;</emphasis>
00080 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00081 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00082 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00083 <emphasis role="comment"></emphasis>
00084 <emphasis role="comment"></emphasis>
00085 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//close&#32;enough?</emphasis>
00086 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;((lastBone.position&#32;-&#32;Target.position).sqrMagnitude&#32;&lt;&#32;Delta&#32;*&#32;Delta)</emphasis>
00087 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;</emphasis>
00088 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00089 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}</emphasis>
00090 <emphasis role="comment"></emphasis>
00091 <emphasis role="comment">&#32;&#32;&#32;&#32;}</emphasis>
00092 <emphasis role="comment">&#32;&#32;&#32;&#32;</emphasis>
00093 <emphasis role="comment"></emphasis>
00094 <emphasis role="comment">}</emphasis>
00095 <emphasis role="comment">*/</emphasis>
</programlisting></section>
